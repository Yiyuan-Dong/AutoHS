# AutoHS
目前还在开发过程中，可能有很多Bug……

欢迎任何批评建议~

原来的脚本是通过计算机视觉手段（分析图片哈希相似度等）来分析局势的，但现在这个方案已经被放弃了（非常不靠谱）。可以在`cv`分支中看到cv相关的代码。

### 如何运行

0. 安装 `Python3`。

1. 安装所需依赖:
```
pip install -r requirements.txt
```

2. 在 `constants/constants` 里有一些参数可以设置，其中有两项必须修改：
    - 名为`HEARTHSTONE_POWER_LOG_PATH`的变量必须修改成你的电脑上的炉石传说日志`Power.log` 的路径，`Power.log` 在炉石安装路径下的 `Logs/`文件夹中。  
    - 名为`YOUR_NAME`的变量需要改成你的炉石用户名，形如`为所欲为、异灵术#54321`。如果不在文件里修改，每次启动脚本时系统都会提示你手动输入用户名。

> `Power.log` 中记录了对战过程中每一个**对象**(**Entity**)的每一项**属性**(**tag**)的变化。
> 这个**对象**包括玩家、英雄、英雄技能、卡牌(无论在牌库里、手牌中、战场上还是坟地里)等。
> 
> `Power.log` 会在进入炉石后第一次对战开始时创建，在退出炉石后自动删除。
> 
> 关于炉石log的更多信息可以查看这个
> [Reddit帖子](https://www.reddit.com/r/hearthstone/comments/268fkk/simple_hearthstone_logging_see_your_complete_play/) 。

3. 可以先跑一跑 `demo/` 下的一些文件。

4. 若要启动脚本，将当前目录切换到`AutoHS/`下（重要!），运行 `python main.py` 即可。注意脚本需要屏幕分辨率为 **1920 * 1080**、炉石**全屏**且语言为**简体中文**，放在**最前台**。 你可以把战网客户端最小化到任务栏，或是放在炉石应用下面，但请不要关闭战网客户端。有时炉石会意外关闭，这时程序会试图重新打开炉石。
   

### 我目前用的挂机卡组 
#### 经典模式－摆烂萨
- 1x (1) 银色侍从
- 2x (1) 闪电箭
- 1x (2) 血法师萨尔诺斯
- 2x (3) 妖术
- 2x (3) 精神控制技师
- 2x (3) 苦痛侍僧
- 2x (3) 闪电风暴
- 2x (3) 麦田傀儡
- 2x (4) 冰风雪人
- 2x (4) 森金持盾卫士
- 2x (5) 土元素
- 2x (5) 碧蓝幼龙
- 1x (6) 凯恩·血蹄
- 2x (6) 火元素
- 2x (6) 烈日行者
- 1x (8) 炎魔之王拉格纳罗斯
- 1x (8) 风领主奥拉基尔
- 1x (9) 奥妮克希亚

神秘代码:
```
AAEDAfWfAwayoQS1oQTboQSYogTaogS+owQM7ZUEr5YEsJYE55YEsaEEvqEE0KEEhKIEi6IEjqIEk6IE1KIEAA==
```

带了很多传说卡牌，只是为了让它看起来不那么像脚本。所有卡牌可以替换成任意**非战吼随从**。

[comment]: <> (### 如果想要用自己的卡组)

[comment]: <> (我觉得需要经过一下几步:)

[comment]: <> (- 你需要能认出每一张手牌， AutoHS使用图片哈希来识别图片， )

[comment]: <> (   你需要录入新卡的哈希， 可以通过 `demo/identify_cards.py` )

[comment]: <> (   去读取手牌卡画哈希)

[comment]: <> (- 把哈希和对应名称录入到 `constants/hash_vals.py` 中)

[comment]: <> (- 写出卡牌逻辑， 可以参照 `card.py`)

[comment]: <> (- 把卡牌和中文名对应， 需要更新 `name2card.py`)

[comment]: <> (好像有点麻烦...)



### 文件说明
- `demo/catch_screen_demo.py` : 运行此文件会获取炉石传说进程的整个截屏
(无论是在前台还是后台)，并画上一些坐标基准线，方便判断想实现的操作的坐标值
- `demo/game_state_snapshot_demo.py` : 在控制台显示目前的炉石战局情况，包括显示手牌情况，英雄情况，随从情况等；
  还会在`demo/`目录下创建一个名为`game_state_sanpshot.txt`的文件，记录log分析情况。
  需要在 `Power.log` 存在，即进入对战模式后调用。
- `demo/get_window_name.py` : 显示当前所有窗口的名称和编号，可以用来看炉石传说叫什么名字……
- `demo/mouse_control_demo.py` : 一个样例程序展现了如何控制鼠标


[comment]: <> (### 关于截取屏幕，以及opnecv2)

[comment]: <> (使用的是win的接口。在矩阵里第一维是行号，而在opencv里，windows接口里和mouse接口里第一维是列号。)

[comment]: <> (矩阵里的色彩排序为&#40;B，G，R&#41;)

[comment]: <> (### 关于控制鼠标)

[comment]: <> (原本想通过发送信号的方式在让炉石在后台也能接收到鼠标点击)

[comment]: <> (但是发现炉石应该是所谓的接受直接输入的进程，信号模拟它不会接收……)

[comment]: <> (所以只能使用很low的鼠标点击了)

[comment]: <> (也许能直接模拟网络发包？)


[comment]: <> (### 关于网络连接的观察)

[comment]: <> (一打开炉石就会建立两个TCP连接，这两个所有的数据都是加密的。像分解卡牌， 只有退出了某个卡牌的分解界面（就是可以撤销的界面）才会发包确认分解结果。)

[comment]: <> (实验下来感觉只有其中一条连接在真的交换数据。)

[comment]: <> (点击匹配会新建一个连接，这个连接是加密的。在匹配完成后连接就销毁。)

[comment]: <> (进入对战会又新建一个连接，这个是纯TCP没有加密，不过我仍然无法解析数据交换的格式……（总之不是json..……）。)

[comment]: <> (任何一个操作都会触发数据传输（比如空中乱晃鼠标……），而如果什么都不做炉石也会每个5秒跟服务器互相ping一下，应该是在确认是否掉线)
